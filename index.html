<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI-Driven Sentiment CRM</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; }
    h1, h2 { margin-bottom: 0.5rem; }
    nav { margin-bottom: 1.5rem; }
    nav button {
      margin-right: 0.5rem; padding: 0.4rem 0.8rem; cursor: pointer;
      border-radius: 0.375rem; border: 1px solid #d1d5db; background: #f9fafb;
    }
    nav button.active { background: #2563eb; color: white; border-color: #1d4ed8; }
    label { display: block; margin-top: 1rem; font-weight: 600; }
    input[type="text"], input[type="password"], textarea {
      width: 100%; padding: 0.5rem; margin-top: 0.3rem; box-sizing: border-box;
      border-radius: 0.375rem; border: 1px solid #d1d5db;
    }
    textarea { min-height: 120px; }
    button.primary {
      margin-top: 1rem; padding: 0.6rem 1.2rem; cursor: pointer;
      border-radius: 0.375rem; border: none; background: #16a34a; color: white;
      font-weight: 600;
    }
    #status { margin-top: 1rem; min-height: 1.5rem; color: #374151; }
    #sentiment-result, #action-result {
      margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem;
      border: 1px solid #d1d5db;
    }
    #sentiment-result span.label { font-weight: 600; }
    #action-result { color: white; font-weight: 600; }
    .small { font-size: 0.9rem; color: #4b5563; }
    section { display: none; }
    section.active { display: block; }
  </style>
</head>
<body>
  <h1>AI-Driven Decision System</h1>
  <nav>
    <button id="tabSettings" class="active">1. Settings</button>
    <button id="tabReview">2. Review & Action</button>
  </nav>

  <!-- SECTION 1: SETTINGS -->
  <section id="sectionSettings" class="active">
    <h2>Step 1: Configure API & Logging</h2>
    <p class="small">
      Paste your Hugging Face API token and Google Apps Script Web App URL (/exec), then click Save.
    </p>

    <label for="hfToken">Hugging Face API Token</label>
    <input type="password" id="hfToken" placeholder="hf_xxx..." />

    <label for="gasUrl">Google Apps Script Web App URL (/exec)</label>
    <input type="text" id="gasUrl" placeholder="https://script.google.com/macros/s/.../exec" />

    <button id="saveSettings" class="primary">Save Settings</button>

    <div id="settingsStatus"></div>
  </section>

  <!-- SECTION 2: REVIEW / DECISION -->
  <section id="sectionReview">
    <h2>Step 2: Analyze Review & Trigger Action</h2>
    <p class="small">
      Enter a product review. The system will call the sentiment model, normalize the score, apply the business rules,
      show the selected action, and log the event to Google Sheets (including action_taken).
    </p>

    <label for="reviewText">Product Review</label>
    <textarea id="reviewText" placeholder="Type or paste a customer review here..."></textarea>

    <button id="analyzeBtn" class="primary">Analyze & Decide</button>

    <div id="status"></div>

    <div id="sentiment-result" style="display:none;">
      <div>Sentiment: <span class="label" id="sentimentLabel"></span></div>
      <div>Confidence: <span id="sentimentScore"></span></div>
      <div>Normalized Score: <span id="normalizedScore"></span></div>
    </div>

    <div id="action-result" style="display:none;">
      <div id="actionMessage"></div>
    </div>

    <p class="small" style="margin-top:1.5rem;">
      Logic matrix:<br>
      0.0 ≤ S ≤ 0.4 → OFFER_COUPON (churn risk)<br>
      0.4 &lt; S &lt; 0.7 → REQUEST_FEEDBACK (uncertain)<br>
      0.7 ≤ S ≤ 1.0 → ASK_REFERRAL (loyal)
    </p>
  </section>

  <script>
    // ---------- SECTION SWITCHING ----------
    const tabSettings = document.getElementById("tabSettings");
    const tabReview   = document.getElementById("tabReview");
    const sectionSettings = document.getElementById("sectionSettings");
    const sectionReview   = document.getElementById("sectionReview");

    function showSection(which) {
      if (which === "settings") {
        sectionSettings.classList.add("active");
        sectionReview.classList.remove("active");
        tabSettings.classList.add("active");
        tabReview.classList.remove("active");
      } else {
        sectionSettings.classList.remove("active");
        sectionReview.classList.add("active");
        tabSettings.classList.remove("active");
        tabReview.classList.add("active");
      }
    }

    tabSettings.addEventListener("click", () => showSection("settings"));
    tabReview.addEventListener("click", () => showSection("review"));

    // ---------- LOCAL STORAGE KEYS ----------
    const LS_KEY_HF_TOKEN = "hf_token";
    const LS_KEY_URL = "gas_url";
    const LS_KEY_UID = "uid";

    function getUserId() {
      let uid = localStorage.getItem(LS_KEY_UID);
      if (!uid) {
        uid = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
        localStorage.setItem(LS_KEY_UID, uid);
      }
      return uid;
    }

    function getGasUrl() {
      return (localStorage.getItem(LS_KEY_URL) || "").trim();
    }

    function getHfToken() {
      return (localStorage.getItem(LS_KEY_HF_TOKEN) || "").trim();
    }

    // ---------- SETTINGS PAGE LOGIC ----------
    function loadSettings() {
      const savedToken = localStorage.getItem(LS_KEY_HF_TOKEN) || "";
      const savedUrl = localStorage.getItem(LS_KEY_URL) || "";
      if (savedToken) document.getElementById("hfToken").value = savedToken;
      if (savedUrl) document.getElementById("gasUrl").value = savedUrl;
      if (savedToken || savedUrl) {
        document.getElementById("settingsStatus").textContent = "Loaded saved settings.";
      }
    }

    function saveSettings() {
      const status = document.getElementById("settingsStatus");
      const token = (document.getElementById("hfToken").value || "").trim();
      const url = (document.getElementById("gasUrl").value || "").trim();

      if (!token) {
        status.textContent = "Please paste your Hugging Face API token.";
        return;
      }
      if (!url) {
        status.textContent = "Please paste your Apps Script Web App URL (ending with /exec).";
        return;
      }
      try { new URL(url); } catch (e) {
        status.textContent = "Invalid Web App URL format.";
        return;
      }

      localStorage.setItem(LS_KEY_HF_TOKEN, token);
      localStorage.setItem(LS_KEY_URL, url);
      status.textContent = "Settings saved.";
    }

    document.getElementById("saveSettings").addEventListener("click", saveSettings);
    loadSettings();

    // ---------- BUSINESS LOGIC ----------
    function determineBusinessAction(confidence, label) {
      let normalizedScore = 0.5; // default neutral

      if (label === "POSITIVE") {
        normalizedScore = confidence;
      } else if (label === "NEGATIVE") {
        normalizedScore = 1.0 - confidence;
      } else if (label === "NEUTRAL") {
        normalizedScore = 0.5;
      }

      if (normalizedScore <= 0.4) {
        return {
          normalizedScore,
          actionCode: "OFFER_COUPON",
          uiMessage: "We are truly sorry. Please accept this 50% discount coupon.",
          uiColor: "#ef4444"
        };
      } else if (normalizedScore < 0.7) {
        return {
          normalizedScore,
          actionCode: "REQUEST_FEEDBACK",
          uiMessage: "Thank you! Could you tell us how we can improve?",
          uiColor: "#6b7280"
        };
      } else {
        return {
          normalizedScore,
          actionCode: "ASK_REFERRAL",
          uiMessage: "Glad you liked it! Refer a friend and earn rewards.",
          uiColor: "#3b82f6"
        };
      }
    }

    // ---------- HF SENTIMENT CALL ----------
    async function callSentimentAPI(text) {
      const token = getHfToken();
      if (!token) {
        throw new Error("Missing Hugging Face API token. Go to Settings first.");
      }

      const response = await fetch(
        "https://router.huggingface.co/hf-inference/models/cardiffnlp/twitter-roberta-base-sentiment-latest",
        {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ inputs: text })
        }
      );

      if (!response.ok) {
        const errText = await response.text();
        throw new Error("HF API error: " + response.status + " " + errText);
      }

      const data = await response.json();
      if (!Array.isArray(data) || data.length === 0) {
        throw new Error("Unexpected HF response format.");
      }

      let best = data[0];
      for (const item of data) {
        if (item.score > best.score) best = item;
      }

      if (!best || typeof best.label !== "string" || typeof best.score !== "number") {
        throw new Error("Unexpected HF response format (no label/score).");
      }

      const label = best.label.toUpperCase(); // POSITIVE / NEGATIVE / NEUTRAL
      return { label, score: best.score };
    }

    // ---------- LOGGING TO GOOGLE SHEETS ----------
    async function logToGoogleSheet({ review, sentiment, confidence, actionCode }) {
      const status = document.getElementById("status");
      const url = getGasUrl();
      if (!url) {
        status.textContent = "Missing Web App URL. Go to Settings first.";
        return "MISSING_URL";
      }

      const userId = getUserId();
      const ts = Date.now();
      const meta = {
        review,
        sentiment,
        confidence,
        action_taken: actionCode
      };

      const form = new URLSearchParams();
      form.set("event", "sentiment_review");
      form.set("variant", sentiment || "");
      form.set("userId", userId);
      form.set("ts", String(ts));
      form.set("meta", JSON.stringify(meta));

      try {
        const res = await fetch(url, {
          method: "POST",
          body: form
        });
        const text = await res.text();
        if (!res.ok) throw new Error("HTTP " + res.status + ": " + text);
        status.textContent = "Logged ✅";
        return text;
      } catch (err) {
        status.textContent = "Log failed: " + String(err);
        return "ERROR: " + String(err);
      }
    }

    // ---------- UI UPDATE HELPERS ----------
    function updateSentimentUI(label, confidence, normalizedScore) {
      const sr = document.getElementById("sentiment-result");
      document.getElementById("sentimentLabel").textContent = label;
      document.getElementById("sentimentScore").textContent = confidence.toFixed(3);
      document.getElementById("normalizedScore").textContent = normalizedScore.toFixed(3);
      sr.style.display = "block";
    }

    function updateActionUI(decision) {
      const ar = document.getElementById("action-result");
      const msg = document.getElementById("actionMessage");
      msg.textContent = decision.uiMessage + " (" + decision.actionCode + ")";
      ar.style.backgroundColor = decision.uiColor;
      ar.style.display = "block";
    }

    // ---------- MAIN BUTTON HANDLER ----------
    async function handleAnalyzeClick() {
      const status = document.getElementById("status");
      const text = (document.getElementById("reviewText").value || "").trim();

      if (!text) {
        status.textContent = "Please enter a review first.";
        return;
      }

      status.textContent = "Analyzing sentiment...";
      document.getElementById("sentiment-result").style.display = "none";
      document.getElementById("action-result").style.display = "none";

      try {
        const result = await callSentimentAPI(text);
        const decision = determineBusinessAction(result.score, result.label);
        updateSentimentUI(result.label, result.score, decision.normalizedScore);
        updateActionUI(decision);
        status.textContent = "Decision made. Logging to Google Sheets...";
        await logToGoogleSheet({
          review: text,
          sentiment: result.label,
          confidence: result.score,
          actionCode: decision.actionCode
        });
      } catch (err) {
        status.textContent = "Error: " + String(err.message || err);
      }
    }

    document.getElementById("analyzeBtn").addEventListener("click", handleAnalyzeClick);
  </script>
</body>
</html>
